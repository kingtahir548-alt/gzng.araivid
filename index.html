<!DOCTYPE html>
<html lang="ku" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gzng Archive System</title>
    <link href="https://fonts.googleapis.com/css2?family=Rudaw:wght@400;700;900&family=Noto+Sans+Arabic:wght@300;400;700;800&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --bg-body: #f0f2f5; --bg-glass: rgba(255, 255, 255, 0.95); --bg-nav: rgba(255, 255, 255, 0.9);
            --bg-card: #ffffff; --text-main: #1e293b; --text-light: #64748b;
            --primary: #6366f1; --primary-gradient: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08); --border: 1px solid rgba(0, 0, 0, 0.05); --radius: 16px;
            --font-main: 'Noto Sans Arabic', 'Rudaw', sans-serif;
        }
        [data-theme="dark"] {
            --bg-body: #0f172a; --bg-glass: rgba(30, 41, 59, 0.9); --bg-nav: rgba(15, 23, 42, 0.9);
            --bg-card: #1e293b; --text-main: #f1f5f9; --text-light: #94a3b8;
            --primary: #818cf8; --primary-gradient: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3); --border: 1px solid rgba(255, 255, 255, 0.1);
        }
        html[lang="en"] { --font-main: 'Roboto', sans-serif; }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: var(--font-main); background-color: var(--bg-body); min-height: 100vh; color: var(--text-main); overflow-x: hidden; padding-top: 80px; padding-bottom: 40px; transition: background-color 0.3s ease; }
        
        .glass { background: var(--bg-glass); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
        button { cursor: pointer; font-family: inherit; border: none; background: none; }

        .navbar { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background: var(--bg-nav); backdrop-filter: blur(15px); border-bottom: var(--border); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .nav-brand { font-size: 1.3em; font-weight: 900; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 10px; }
        .nav-logo-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; object-fit: contain; background: transparent; }
        .nav-right { display: flex; align-items: center; gap: 10px; }
        
        .icon-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2em; transition: 0.3s; color: var(--text-main); font-weight: bold; border: 1px solid transparent; }
        .icon-btn:hover { background: rgba(128,128,128,0.1); border-color: var(--border); }

        .lang-dropdown { position: relative; }
        .lang-menu {
            position: absolute; top: 120%; left: -10px; background: var(--bg-card); border: var(--border); border-radius: 12px;
            box-shadow: var(--shadow); width: 160px; display: none; flex-direction: column; overflow: hidden; z-index: 2000;
        }
        html[dir="ltr"] .lang-menu { right: -10px; left: auto; }
        .lang-menu.show { display: flex; animation: fadeIn 0.2s ease; }
        .lang-item { padding: 12px 15px; text-align: start; cursor: pointer; transition: 0.2s; font-size: 0.95em; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        .lang-item:hover { background: rgba(128,128,128,0.1); color: var(--primary); }

        .admin-link-btn { background: rgba(128,128,128,0.1); color: var(--text-main); padding: 8px 15px; border-radius: 50px; font-weight: bold; font-size: 0.9em; display: flex; align-items: center; gap: 6px; transition: 0.3s; }
        .admin-link-btn:hover { background: var(--primary); color: white; }
        .admin-link-btn .i18n-text { font-size: 0.9em; }

        .container { max-width: 1200px; margin: 0 auto; width: 95%; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Stats Bar Home */
        .stats-bar-home { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
        .stat-small { background: var(--bg-card); padding: 10px 20px; border-radius: 12px; border: var(--border); box-shadow: var(--shadow); display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 0.9em; }
        .stat-small span { color: var(--primary); font-size: 1.2em; }

        .nav-pills { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; margin-top: 10px; flex-wrap: wrap; }
        .pill { padding: 10px 25px; border-radius: 50px; font-weight: bold; color: var(--text-light); background: var(--bg-card); border: var(--border); transition: 0.3s; display: flex; align-items: center; gap: 5px;}
        .pill.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); transform: scale(1.05); border-color: transparent; }

        .search-area { max-width: 600px; margin: 0 auto 20px; position: relative; }
        .search-input { width: 100%; padding: 15px 20px; border-radius: 50px; border: var(--border); background: var(--bg-card); color: var(--text-main); font-size: 1em; box-shadow: var(--shadow); transition: 0.3s; font-family: var(--font-main); }
        .search-input:focus { transform: scale(1.01); border-color: var(--primary); }
        
        .add-activity-btn { display: flex; align-items: center; justify-content: center; gap: 10px; background: var(--primary-gradient); color: white; padding: 12px 25px; border-radius: 50px; font-weight: bold; margin: 0 auto 30px; box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3); transition: 0.3s; width: fit-content; }
        .add-activity-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4); }

        .filter-header { display: none; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 25px; background: var(--bg-card); border-radius: 15px; border: var(--border); }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .card { background: var(--bg-card); border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); border: var(--border); display: flex; flex-direction: column; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); }
        
        .card-img-grid { display: grid; grid-template-columns: 1fr 1fr; height: 180px; width: 100%; gap: 1px; background: #e2e8f0; flex-shrink: 0; }
        .card-img-grid img { width: 100%; height: 100%; object-fit: cover; }
        
        .card-body { padding: 15px; flex-grow: 1; background: var(--bg-card); position: relative; z-index: 2; }
        .card-title { font-weight: 800; font-size: 1.1em; margin-bottom: 8px; color: var(--text-main); }
        .card-info { font-size: 0.85em; color: var(--text-light); display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .card-footer { padding: 12px 15px; background: rgba(128,128,128,0.03); border-top: 1px solid rgba(128,128,128,0.05); }
        
        .btn-card {
            background-color: #2563eb !important;
            color: white !important;
            padding: 10px 20px !important;
            border-radius: 8px !important;
            border: none !important;
            font-family: 'Rudaw', sans-serif !important;
            font-size: 14px !important;
            font-weight: bold !important;
            cursor: pointer !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 8px !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2) !important;
            width: 100% !important;
            margin-top: 10px !important;
        }
        .btn-card:hover {
            background-color: #1d4ed8 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.3) !important;
        }

        .teacher-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; }
        .teacher-item { text-align: center; padding: 20px 10px; background: var(--bg-card); border-radius: 20px; transition: 0.3s; border: var(--border); cursor: pointer; box-shadow: var(--shadow); }
        .teacher-item:hover { transform: translateY(-5px); border-color: var(--primary); }
        .avatar-lg { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 10px; object-fit: contain; border: 3px solid var(--primary); padding: 10px; background: var(--bg-body); }

        .admin-dashboard { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 2000; overflow-y: auto; display: none; }
        .admin-nav { position: sticky; top: 0; background: #1e293b; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 10; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 3000; display: none; justify-content: center; align-items: center; padding: 20px; opacity: 0; transition: opacity 0.2s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .editor-container { width: 100%; max-width: 900px; display: flex; flex-direction: column; gap: 15px; height: 90vh; }
        .editor-toolbar { background: #1e293b; padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; color: white; }
        .paper-area { background: #334155; padding: 20px; border-radius: 15px; flex-grow: 1; overflow: auto; display: flex; justify-content: center; }
        .a4-page { width: 210mm; min-height: 297mm; background: white; padding: 15mm; color: black; direction: rtl; text-align: right; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        html[dir="ltr"] .a4-page { text-align: left; direction: ltr; }
        
        .p-header { display: flex; align-items: center; justify-content: space-between; border-bottom: 1.5px solid black; padding-bottom: 6px; margin-bottom: 8px; }
        .p-header h1 { font-size: 18px !important; margin: 0 !important; line-height: 1.2; }
        .p-header p { font-size: 11px; margin: 2px 0 0 !important; color: #555; }
        .p-header img { height: 110px !important; width: auto !important; max-width: 250px !important; object-fit: contain !important; display: block !important; }

        .p-form { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: #f8fafc; padding: 10px; border: 1px solid #e2e8f0; margin-bottom: 12px; }
        .p-input { width: 100%; border: none; border-bottom: 1px dashed #cbd5e1; background: transparent; font-weight: bold; padding: 2px; font-family: inherit; }

        .p-images { display: grid; gap: 10px; margin-top: 12px; }
        .p-images.landscape { grid-template-columns: 1fr 1fr; }
        .p-images.landscape .slot { height: 180px; }
        .p-images.portrait { grid-template-columns: 1fr 1fr; }
        .p-images.portrait .slot { height: 280px; }

        .slot { background: #f1f5f9; border: 2px dashed #cbd5e1; border-radius: 8px; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .slot img { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; }

        .controls { position: absolute; bottom: 5px; display: flex; gap: 5px; background: rgba(0,0,0,0.6); padding: 5px; border-radius: 20px; opacity: 0; transition: 0.2s; }
        .slot:hover .controls { opacity: 1; }
        .c-btn { width: 25px; height: 25px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* Custom Confirm Modal */
        #confirmModal .modal-body { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 380px; text-align: center; }
        .modal-btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn-m { flex: 1; padding: 12px; border-radius: 12px; font-weight: 700; }
        .btn-cancel { background: #f1f5f9; color: #475569; }
        .btn-danger { background: #ef4444; color: white; }

        /* Toast notifications */
        #toastContainer { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #1e293b; color: white; padding: 12px 25px; border-radius: 12px; box-shadow: var(--shadow); font-weight: 700; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        @media print {
            body * { visibility: hidden; } .a4-page, .a4-page * { visibility: visible; }
            .a4-page { position: absolute; left: 0; top: 0; margin: 0; padding: 10mm; width: 210mm; height: 297mm; }
            .controls, .editor-toolbar, .modal-overlay { display: none !important; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-brand">
            <img src="https://i.ibb.co/5hgx3xgZ/logo-gzng.png" class="nav-logo-icon">
            <span data-i18n="app_title">Ø¦Û•Ø±Ø´ÛŒÙÛŒ Ú¯Ø²Ù†Ú¯</span>
        </div>
        <div class="nav-right">
            <div class="lang-dropdown">
                <button onclick="toggleLangMenu()" class="icon-btn">ğŸŒ</button>
                <div id="langMenu" class="lang-menu">
                    <div class="lang-item" onclick="setLang('ku')"><span>ğŸ³ï¸</span> Ú©ÙˆØ±Ø¯ÛŒ</div>
                    <div class="lang-item" onclick="setLang('en')"><span>ğŸ‡ºğŸ‡¸</span> English</div>
                    <div class="lang-item" onclick="setLang('ar')"><span>ğŸ‡®ğŸ‡¶</span> Ø¹Ø±Ø¨ÙŠ</div>
                </div>
            </div>
            <button onclick="toggleTheme()" class="icon-btn" id="themeIcon">ğŸŒ™</button>
            <button id="adminBtn" class="admin-link-btn"><span>ğŸ”‘</span> <span data-i18n="btn_admin" class="i18n-text">Ø¦Û•Ø¯Ù…ÛŒÙ†</span></button>
        </div>
    </nav>

    <div id="mainContent">
        <div class="container">
            <!-- Stats Section -->
            <div class="stats-bar-home" id="statsBar">
                <div class="stat-small">
                    <span id="homeStatActs">0</span> <p data-i18n="stat_activity">Ú†Ø§Ù„Ø§Ú©ÛŒ</p>
                </div>
                <div class="stat-small">
                    <span id="homeStatTeachers">0</span> <p data-i18n="stat_teacher">Ù…Ø§Ù…Û†Ø³ØªØ§</p>
                </div>
            </div>

            <div class="nav-pills">
                <button onclick="switchView('archive')" class="pill active" id="btn-archive" data-i18n="tab_archive">Ø¦Û•Ø±Ø´ÛŒÙ</button>
                <button onclick="switchView('teachers')" class="pill" id="btn-teachers" data-i18n="tab_teachers">Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†</button>
                <button onclick="window.open('https://gzng-school.vercel.app/', '_blank')" class="pill" style="background: #ecfdf5; color: #059669; border-color: #10b981;">
                    ğŸ“… <span data-i18n="btn_schedule">Ø®Ø´ØªÛ•ÛŒ Ú•Û†Ú˜Ø§Ù†Û•</span>
                </button>
            </div>
            
            <div id="archiveControls">
                <div class="search-area"><input type="text" class="search-input" id="searchBox" placeholder="Ú¯Û•Ú•Ø§Ù† Ù„Û• Ø¨Ø§Ø¨Û•ØªØŒ Ù…Ø§Ù…Û†Ø³ØªØ§ ÛŒØ§Ù† ØªÛØ¨ÛŒÙ†ÛŒ..."></div>
                <div style="text-align:center;"><button onclick="openEditor()" class="add-activity-btn" id="btnAddActivity"><span>â•</span> <span data-i18n="btn_add_activity">Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ Ù†ÙˆÛ</span></button></div>
            </div>

            <div id="filterHeader" class="filter-header">
                <div style="display:flex; align-items:center; gap:15px;"><div id="filterAvatarContainer"></div><h2 id="filterName" style="font-size:1.2em; margin:0;"></h2></div>
                <button onclick="clearFilter()" style="color:#ef4444; background:rgba(239, 68, 68, 0.1); padding:8px 15px; border-radius:10px;" data-i18n="btn_back">âŒ Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ•</button>
            </div>

            <div id="activitiesGrid" class="grid"></div>
            <div id="teachersGrid" class="teacher-grid" style="display:none;"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="adminAuthModal" class="modal-overlay" style="z-index:9000;">
        <div class="glass" style="background:white; padding:30px; width:90%; max-width:350px; text-align:center;">
            <h3 data-i18n="admin_login_title">Ø¨Û•Ú•ÛÙˆÛ•Ø¨Û•Ø±</h3>
            <input type="email" id="adminEmail" placeholder="Email" class="search-input" style="margin:15px 0 10px; border:1px solid #ddd;">
            <input type="password" id="adminPass" placeholder="Password" class="search-input" style="margin-bottom:20px; border:1px solid #ddd;">
            <button onclick="loginAdmin()" class="admin-link-btn" style="width:100%; justify-content:center; background:var(--primary); color:white;" data-i18n="btn_login">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
            <button onclick="document.getElementById('adminAuthModal').classList.remove('active')" style="margin-top:15px; color:#666;" data-i18n="btn_close">Ø¯Ø§Ø®Ø³ØªÙ†</button>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirmModal" class="modal-overlay" style="z-index:11000;">
        <div class="modal-body glass">
            <h3 id="confirmTitle">Ø¯ÚµÙ†ÛŒØ§ÛŒØŸ</h3>
            <p id="confirmText" style="margin-top:10px; color:#64748b;"></p>
            <div class="modal-btn-group">
                <button id="confirmCancel" class="btn-m btn-cancel" data-i18n="btn_close">Ø¯Ø§Ø®Ø³ØªÙ†</button>
                <button id="confirmOk" class="btn-m btn-danger">Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="admin-dashboard">
        <div class="admin-nav">
            <h2 style="display:flex; align-items:center; gap:10px;">âš™ï¸ <span data-i18n="dashboard">Ø¯Ø§Ø´Ø¨Û†Ø±Ø¯</span></h2>
            <div style="display:flex; gap:10px;">
                <button onclick="closeAdminDashboard()" style="background:#3b82f6; color:white; padding:8px 15px; border-radius:8px;" data-i18n="btn_back_site">ğŸ”™ Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ•</button>
                <button onclick="logoutAdmin()" style="background:#ef4444; color:white; padding:8px 15px; border-radius:8px;" data-i18n="btn_logout">Ø¯Û•Ø±Ú†ÙˆÙˆÙ†</button>
            </div>
        </div>
        <div class="container" style="padding-top:30px;">
            <div class="grid" style="margin-bottom:30px;">
                <div class="card" style="padding:20px; text-align:center;"><div style="font-size:2.5em; font-weight:900; color:var(--primary);" id="statActivities">0</div><p data-i18n="stat_activity">Ú†Ø§Ù„Ø§Ú©ÛŒ</p></div>
                <div class="card" style="padding:20px; text-align:center;"><div style="font-size:2.5em; font-weight:900; color:var(--primary);" id="statTeachers">0</div><p data-i18n="stat_teacher">Ù…Ø§Ù…Û†Ø³ØªØ§</p></div>
            </div>
            <div class="nav-pills">
                <button onclick="switchAdminTab('activities')" id="tab-admin-acts" class="pill active" data-i18n="manage_activities">Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒÛŒÛ•Ú©Ø§Ù†</button>
                <button onclick="switchAdminTab('teachers')" id="tab-admin-teach" class="pill" data-i18n="manage_teachers">Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†</button>
            </div>
            <div id="adminActivitiesView" class="glass" style="padding:20px; background:var(--bg-card);">
                <table style="width:100%; border-collapse:collapse;">
                    <thead><tr style="text-align:inherit; border-bottom:2px solid #eee;"><th style="padding:15px;" data-i18n="lbl_subject">Ø¨Ø§Ø¨Û•Øª</th><th data-i18n="lbl_teacher">Ù…Ø§Ù…Û†Ø³ØªØ§</th><th data-i18n="lbl_action">Ú©Ø±Ø¯Ø§Ø±</th></tr></thead>
                    <tbody id="adminActivitiesTable"></tbody>
                </table>
            </div>
            <div id="adminTeachersView" class="glass" style="padding:20px; display:none; background:var(--bg-card);">
                <button onclick="openAddTeacherModal()" class="admin-link-btn" style="background:var(--primary); color:white; margin-bottom:20px;">â• <span data-i18n="btn_add_teacher">Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§</span></button>
                <div id="adminTeachersGrid" class="teacher-grid"></div>
            </div>
        </div>
    </div>

    <!-- Editor Modal -->
    <div id="editorModal" class="modal-overlay">
        <div class="editor-container">
            <div class="editor-toolbar">
                <button onclick="closeEditor()" style="color:#ef4444; font-weight:bold;" data-i18n="btn_close">Ø¯Ø§Ø®Ø³ØªÙ†</button>
                <div style="display:flex; gap:10px;"><button onclick="setLayout('landscape')" style="background:#334155; padding:5px 10px; border-radius:5px;" data-i18n="layout_landscape">ÙˆÛÙ†Û•ÛŒ Ù¾Ø§Ù†</button><button onclick="setLayout('portrait')" style="background:#334155; padding:5px 10px; border-radius:5px;" data-i18n="layout_portrait">ÙˆÛÙ†Û•ÛŒ Ø¯Ø±ÛÚ˜</button></div>
                <div style="display:flex; gap:10px;">
                    <button onclick="downloadJPEG()" style="background:white; color:black; padding:5px 10px; border-radius:5px;">â¬‡ï¸ JPG</button>
                    <button onclick="window.print()" style="background:white; color:black; padding:5px 10px; border-radius:5px;">ğŸ–¨ï¸</button>
                    <button onclick="saveToArchive()" id="btnSaveArchive" style="background:var(--primary); color:white; padding:5px 15px; border-radius:5px;" data-i18n="btn_save">ğŸ’¾ Ø³Û•ÛŒÚ¤</button>
                </div>
            </div>
            <div class="paper-area">
                <div class="a4-page" id="reportPaper">
                    <div class="p-header">
                        <div><h1 style="font-size:24px; color:black; margin:0;" data-i18n="school_name">Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</h1><p style="color:#666; margin-top:5px;" data-i18n="report_form">ÙÛ†Ø±Ù…ÛŒ Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ</p></div>
                        <img src="https://i.ibb.co/5hgx3xgZ/logo-gzng.png" style="width:80px; height:80px; object-fit:contain;">
                    </div>
                    <div class="p-form">
                        <div><label style="font-size:12px; color:#666;" data-i18n="lbl_subject">Ø¨Ø§Ø¨Û•Øª</label><input id="inpName" class="p-input"></div>
                        <div><label style="font-size:12px; color:#666;" data-i18n="lbl_committee">Ù„ÛŒÚ˜Ù†Û•</label><input id="inpComm" class="p-input"></div>
                        <div><label style="font-size:12px; color:#666;" data-i18n="lbl_teacher">Ù…Ø§Ù…Û†Ø³ØªØ§</label><select id="inpTeacher" class="p-input" style="background:white;"><option value="">...</option></select></div>
                        <div><label style="font-size:12px; color:#666;" data-i18n="lbl_date">Ø¨Û•Ø±ÙˆØ§Ø±</label><input id="inpDate" type="date" class="p-input"></div>
                    </div>
                   <textarea id="inpNotes" style="width:100%; height:120px; border:1px solid #ddd; padding:10px; resize:none; font-family:inherit; margin-bottom:10px;" placeholder="..."></textarea>

                    <div id="imgContainer" class="p-images landscape">
                        <div class="slot" id="slot0" onmousedown="startDrag(event, 0)" ontouchstart="startDrag(event, 0)"><img id="img0"><div class="controls"><div class="c-btn" onclick="triggerFile(0)">ğŸ“‚</div><div class="c-btn" onclick="adjustZoom(0, 0.1)">+</div><div class="c-btn" onclick="adjustZoom(0, -0.1)">-</div></div></div>
                        <div class="slot" id="slot1" onmousedown="startDrag(event, 1)" ontouchstart="startDrag(event, 1)"><img id="img1"><div class="controls"><div class="c-btn" onclick="triggerFile(1)">ğŸ“‚</div><div class="c-btn" onclick="adjustZoom(1, 0.1)">+</div><div class="c-btn" onclick="adjustZoom(1, -0.1)">-</div></div></div>
                        <div class="slot" id="slot2" onmousedown="startDrag(event, 2)" ontouchstart="startDrag(event, 2)"><img id="img2"><div class="controls"><div class="c-btn" onclick="triggerFile(2)">ğŸ“‚</div><div class="c-btn" onclick="adjustZoom(2, 0.1)">+</div><div class="c-btn" onclick="adjustZoom(2, -0.1)">-</div></div></div>
                        <div class="slot" id="slot3" onmousedown="startDrag(event, 3)" ontouchstart="startDrag(event, 3)"><img id="img3"><div class="controls"><div class="c-btn" onclick="triggerFile(3)">ğŸ“‚</div><div class="c-btn" onclick="adjustZoom(3, 0.1)">+</div><div class="c-btn" onclick="adjustZoom(3, -0.1)">-</div></div></div>
                    </div>
                    <div style="margin-top:auto; text-align:center; font-size:12px; color:#999; border-top:1px solid #eee; padding-top:10px;" data-i18n="school_footer">Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯ÛŒ Ø¦ÛŒÙ†Ú¯Ù„ÛŒØ²ÛŒ Ù†Ø§Ø­Ú©ÙˆÙ…ÛŒ</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher Edit Modal -->
    <div id="teacherEditModal" class="modal-overlay" style="z-index:9200;">
        <div class="glass" style="background:white; padding:30px; width:90%; max-width:400px; border-radius:20px;">
            <h3 style="margin-bottom:20px;" id="teacherModalTitle" data-i18n="teacher_info">Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§</h3>
            <input type="hidden" id="editTeacherId">
            <label style="font-size:0.9em; color:gray;" data-i18n="lbl_name">Ù†Ø§Ùˆ</label>
            <input id="editTeacherName" type="text" class="search-input" style="border:1px solid #ddd; margin:5px 0 15px; padding:10px;">
            <label style="font-size:0.9em; color:gray;" data-i18n="lbl_gender">Ú•Û•Ú¯Û•Ø²</label>
            <select id="editTeacherGender" class="search-input" style="border:1px solid #ddd; margin:5px 0 15px; padding:10px;">
                <option value="male">ğŸ‘¨â€ğŸ« Male</option>
                <option value="female">ğŸ‘©â€ğŸ« Female</option>
            </select>
            <label style="font-size:0.9em; color:gray;" data-i18n="lbl_photo">ÙˆÛÙ†Û•</label>
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:20px; flex-wrap:wrap;">
                <img id="editTeacherPreview" src="" style="width:50px; height:50px; border-radius:50%; border:1px solid #ddd; object-fit:contain; display:none;">
                <button onclick="document.getElementById('editTeacherFile').click()" class="admin-link-btn" style="background:#e0e7ff; color:blue;" data-i18n="btn_change">ğŸ“· Ú¯Û†Ú•ÛŒÙ†</button>
                <button onclick="removeTeacherPhoto()" class="admin-link-btn" style="background:#fee2e2; color:red;" data-i18n="btn_remove_photo">âŒ Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button>
            </div>
            <button onclick="saveTeacherChanges()" class="admin-link-btn" id="btnSaveTeacher" style="width:100%; justify-content:center; background:var(--primary); color:white; padding:12px;" data-i18n="btn_save">Ø³Û•ÛŒÚ¤Ú©Ø±Ø¯Ù†</button>
            <button onclick="document.getElementById('teacherEditModal').classList.remove('active')" style="margin-top:10px; width:100%; color:#666;" data-i18n="btn_close">Ø¯Ø§Ø®Ø³ØªÙ†</button>
        </div>
    </div>

    <div id="toastContainer"></div>

    <input type="file" id="hiddenFileInput" accept="image/*" style="display:none;">
    <input type="file" id="editTeacherFile" style="display:none;" accept="image/*" onchange="previewTeacherImage(this)">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, updateDoc, where, writeBatch, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        const IMGBB_API_KEY = "0792200cd18a10eadeeccf373d03e4f7"; 

        const firebaseConfig = {
            apiKey: "AIzaSyAr_JHCa5BbM5RJ9KCp0IBom1rdAgVX4CM",
            authDomain: "gzng-f4273.firebaseapp.com",
            projectId: "gzng-f4273",
            storageBucket: "gzng-f4273.firebasestorage.app",
            messagingSenderId: "417779309632",
            appId: "1:417779309632:web:6ed119d26baa35822cd3a5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const actRef = collection(db, "activities");
        const teachRef = collection(db, "teachers");

        let acts=[], teachers=[], user=null;
        window.localFiles=[null,null,null,null]; window.currentSlot=0;
        window.imgState={0:{s:1,x:0,y:0},1:{s:1,x:0,y:0},2:{s:1,x:0,y:0},3:{s:1,x:0,y:0}};
        let currentFilter=null, tempTeacherFile = null, removePhotoFlag = false;

        const MALE_ICON = "https://cdn-icons-png.flaticon.com/512/4042/4042356.png";
        const FEMALE_ICON = "https://cdn-icons-png.flaticon.com/512/4042/4042422.png";

        const translations = {
            ku: {
                app_title: "Ø¦Û•Ø±Ø´ÛŒÙÛŒ Ú¯Ø²Ù†Ú¯", btn_admin: "Ø¦Û•Ø¯Ù…ÛŒÙ†", tab_archive: "Ø¦Û•Ø±Ø´ÛŒÙ", tab_teachers: "Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†", btn_schedule: "Ø®Ø´ØªÛ•ÛŒ Ú•Û†Ú˜Ø§Ù†Û•",
                btn_add_activity: "Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ Ù†ÙˆÛ", btn_back: "Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ•", dashboard: "Ø¯Ø§Ø´Ø¨Û†Ø±Ø¯",
                stat_activity: "Ú†Ø§Ù„Ø§Ú©ÛŒ", stat_teacher: "Ù…Ø§Ù…Û†Ø³ØªØ§", manage_activities: "Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒÛŒÛ•Ú©Ø§Ù†",
                manage_teachers: "Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†", lbl_subject: "Ø¨Ø§Ø¨Û•Øª", lbl_teacher: "Ù…Ø§Ù…Û†Ø³ØªØ§", lbl_action: "Ú©Ø±Ø¯Ø§Ø±",
                btn_add_teacher: "Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§", btn_back_site: "Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ• Ø¨Û† Ø³Ø§ÛŒØª", btn_logout: "Ø¯Û•Ø±Ú†ÙˆÙˆÙ†",
                btn_close: "Ø¯Ø§Ø®Ø³ØªÙ†", btn_save: "Ø³Û•ÛŒÚ¤", layout_landscape: "ÙˆÛÙ†Û•ÛŒ Ù¾Ø§Ù†", layout_portrait: "ÙˆÛÙ†Û•ÛŒ Ø¯Ø±ÛÚ˜",
                school_name: "Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯", report_form: "ÙÛ†Ø±Ù…ÛŒ Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ", lbl_committee: "Ù„ÛŒÚ˜Ù†Û•", lbl_date: "Ø¨Û•Ø±ÙˆØ§Ø±",
                school_footer: "Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯ÛŒ Ø¦ÛŒÙ†Ú¯Ù„ÛŒØ²ÛŒ Ù†Ø§Ø­Ú©ÙˆÙ…ÛŒ", teacher_info: "Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§", lbl_name: "Ù†Ø§Ùˆ", lbl_gender: "Ú•Û•Ú¯Û•Ø²",
                lbl_photo: "ÙˆÛÙ†Û•", btn_change: "Ú¯Û†Ú•ÛŒÙ†", btn_remove_photo: "Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ ÙˆÛÙ†Û•", view_report: "Ø¨ÛŒÙ†ÛŒÙ†ÛŒ Ú•Ø§Ù¾Û†Ø±Øª",
                secure_area: "Ù†Ø§ÙˆÚ†Û•ÛŒ Ù¾Ø§Ø±ÛØ²Ø±Ø§Ùˆ", btn_login: "Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•", error_pass: "Ù‡Û•ÚµÛ•ÛŒÛ•", admin_login_title: "Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†", search: "Ú¯Û•Ú•Ø§Ù†..."
            },
            en: {
                app_title: "Gzng Archive", btn_admin: "Admin", tab_archive: "Archive", tab_teachers: "Teachers", btn_schedule: "Schedule",
                btn_add_activity: "New Activity", btn_back: "Back", dashboard: "Dashboard",
                stat_activity: "Activities", stat_teacher: "Teachers", manage_activities: "Activities",
                manage_teachers: "Teachers", lbl_subject: "Subject", lbl_teacher: "Teacher", lbl_action: "Action",
                btn_add_teacher: "Add Teacher", btn_back_site: "Back", btn_logout: "Logout",
                btn_close: "Close", btn_save: "Save", layout_landscape: "Landscape", layout_portrait: "Portrait",
                school_name: "Gzng School", report_form: "Report", lbl_committee: "Committee", lbl_date: "Date",
                school_footer: "Gzng School", teacher_info: "Teacher Info", lbl_name: "Name", lbl_gender: "Gender",
                lbl_photo: "Photo", btn_change: "Change", btn_remove_photo: "Remove", view_report: "View",
                secure_area: "Secure", btn_login: "Login", error_pass: "Error", admin_login_title: "Admin Login", search: "Search..."
            }
        };

        // --- UI Utilities ---
        window.showToast = (msg) => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };

        window.customConfirm = (title, text, onOk) => {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmText').innerText = text;
            modal.classList.add('active');
            
            const btnOk = document.getElementById('confirmOk');
            const btnCancel = document.getElementById('confirmCancel');
            
            const close = () => modal.classList.remove('active');
            
            btnOk.onclick = () => { onOk(); close(); };
            btnCancel.onclick = close;
        };

        window.toggleLangMenu = () => { document.getElementById('langMenu').classList.toggle('show'); };
        window.setLang = (lang) => { localStorage.setItem('lang', lang); location.reload(); };
        let currentLang = localStorage.getItem('lang') || 'ku';
        document.documentElement.setAttribute('lang', currentLang);
        document.documentElement.setAttribute('dir', currentLang === 'en' ? 'ltr' : 'rtl');
        function t(key) { return translations[currentLang][key] || key; }
        
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(translations[currentLang][key]) el.innerText = translations[currentLang][key];
        });

        window.toggleTheme = () => {
            const html = document.documentElement;
            const next = html.getAttribute('data-theme')==='dark'?'light':'dark';
            html.setAttribute('data-theme',next); localStorage.setItem('theme',next);
            document.getElementById('themeIcon').innerText = next==='dark'?'â˜€ï¸':'ğŸŒ™';
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            const btn = document.getElementById('adminBtn');
            if(u){
                btn.innerHTML=`<span>âš™ï¸</span> <span>${t('dashboard')}</span>`; 
                btn.onclick=openAdminDashboard;
            } else {
                btn.innerHTML=`<span>ğŸ”‘</span> <span>${t('btn_admin')}</span>`; 
                btn.onclick=()=>document.getElementById('adminAuthModal').classList.add('active');
            }
        });

        window.loginAdmin=async()=>{
            try{
                await signInWithEmailAndPassword(auth,document.getElementById('adminEmail').value,document.getElementById('adminPass').value); 
                document.getElementById('adminAuthModal').classList.remove('active');
                showToast("Ø¨Û•Ø®ÛØ± Ø¨ÛÛŒØªÛ•ÙˆÛ•!");
            }catch(e){
                showToast(t('error_pass'));
            }
        };

        window.logoutAdmin=async()=>{
            customConfirm("Ø¯Û•Ø±Ú†ÙˆÙˆÙ†", "Ø¦Ø§ÛŒØ§ Ø¯ÚµÙ†ÛŒØ§ÛŒ Ù„Û• Ø¯Û•Ø±Ú†ÙˆÙˆÙ† Ù„Û• Ø¦Û•Ú©Ø§ÙˆÙ†ØªÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†ØŸ", async () => {
                await signOut(auth); closeAdminDashboard();
                showToast("Ø¯Û•Ø±Ú†ÙˆÙˆÙ† Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ Ø¨ÙˆÙˆ");
            });
        };

        onSnapshot(query(actRef, orderBy("date", "desc")), (s) => { 
            acts = s.docs.map(d=>({id:d.id, ...d.data()})); 
            renderApp(); renderAdminContent(); 
        });
        onSnapshot(teachRef, (s) => { 
            teachers = s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>a.name.localeCompare(b.name,'ku')); 
            updateDropdown(); renderApp(); renderAdminContent(); 
        });

        function getTeacherImg(t) { return (t.photo && t.photo.length > 10) ? t.photo : (t.gender === 'female' ? FEMALE_ICON : MALE_ICON); }
        function updateDropdown(){
            const s=document.getElementById('inpTeacher'); if(!s) return;
            const currentVal = s.value;
            s.innerHTML='<option value="">...</option>';
            teachers.forEach(t=>{const o=document.createElement('option'); o.value=t.name; o.text=t.name; s.appendChild(o)});
            s.value = currentVal;
        }

        function renderApp(){
            // Home Stats
            document.getElementById('homeStatActs').innerText = acts.length;
            document.getElementById('homeStatTeachers').innerText = teachers.length;

            if(currentFilter) { renderFilter(); return; }
            const term = document.getElementById('searchBox').value.toLowerCase();
            
            // Search logic improved: Subject, Teacher, AND Notes
            const list = acts.filter(a => 
                a.name.toLowerCase().includes(term) || 
                a.teacher.toLowerCase().includes(term) ||
                (a.notes && a.notes.toLowerCase().includes(term))
            );

            document.getElementById('activitiesGrid').innerHTML = list.map(a => `
                <div class="card">
                    <div class="card-img-grid">${(a.images||[]).slice(0,4).map(u=>`<img src="${u}">`).join('')}</div>
                    <div class="card-body"><div class="card-title">${a.name}</div><div class="card-info">ğŸ“… ${a.date} | ğŸ‘¤ ${a.teacher}</div></div>
                    <div class="card-footer"><button class="btn-card" onclick="viewReport('${a.id}')">${t('view_report')}</button></div>
                </div>
            `).join('');
            
            const tMap = {}; acts.forEach(a => tMap[a.teacher] = (tMap[a.teacher] || 0) + 1);
            document.getElementById('teachersGrid').innerHTML = teachers.map(prof => `
                <div class="teacher-item" onclick="filterT('${prof.name}')">
                    <img src="${getTeacherImg(prof)}" class="avatar-lg">
                    <div style="font-weight:bold;">${prof.name}</div>
                    <div style="color:gray; font-size:0.8em;">${tMap[prof.name]||0} ${t('stat_activity')}</div>
                </div>
            `).join('');
        }

        window.filterT=(n)=>{
            currentFilter=n; 
            switchView('archive'); 
            window.scrollTo({ top: 0, behavior: 'smooth' });
            renderApp(); 
        };
        
        function renderFilter(){
            document.getElementById('archiveControls').style.display='none'; 
            document.getElementById('statsBar').style.display='none';
            document.getElementById('filterHeader').style.display='flex';
            document.getElementById('filterName').innerText=currentFilter;
            const m=teachers.find(t=>t.name===currentFilter);
            document.getElementById('filterAvatarContainer').innerHTML=`<img src="${m?getTeacherImg(m):MALE_ICON}" style="width:50px;height:50px;border-radius:50%;object-fit:contain;">`;
            
            const list=acts.filter(a=>a.teacher===currentFilter);
            document.getElementById('activitiesGrid').innerHTML=list.map(a=>`
                <div class="card">
                    <div class="card-img-grid">${(a.images||[]).slice(0,4).map(u=>`<img src="${u}">`).join('')}</div>
                    <div class="card-body"><div class="card-title">${a.name}</div><div class="card-info">ğŸ“… ${a.date}</div></div>
                   <button class="btn-card" onclick="viewReport('${a.id}')">${t('view_report')}</button>
                </div>
            `).join('');
        }

        window.clearFilter=()=>{
            currentFilter=null; 
            document.getElementById('filterHeader').style.display='none'; 
            document.getElementById('archiveControls').style.display='block'; 
            document.getElementById('statsBar').style.display='flex';
            renderApp();
        }

        window.switchView=(v)=>{
            document.getElementById('activitiesGrid').style.display=v==='archive'?'grid':'none';
            document.getElementById('teachersGrid').style.display=v==='teachers'?'grid':'none';
            document.getElementById('btn-archive').classList.toggle('active',v==='archive');
            document.getElementById('btn-teachers').classList.toggle('active',v==='teachers');
            document.getElementById('archiveControls').style.display=(v==='archive'&&!currentFilter)?'block':'none';
            document.getElementById('statsBar').style.display=(v==='archive'&&!currentFilter)?'flex':'none';
        };

        document.getElementById('searchBox').addEventListener('input',renderApp);

        window.openAdminDashboard=()=>{document.getElementById('adminDashboard').style.display='block'; renderAdminContent();};
        window.closeAdminDashboard=()=>{document.getElementById('adminDashboard').style.display='none';};
        
        function renderAdminContent(){
            if(!user) return;
            document.getElementById('statActivities').innerText=acts.length; 
            document.getElementById('statTeachers').innerText=teachers.length;
            document.getElementById('adminActivitiesTable').innerHTML=acts.map(a=>`
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:15px;">${a.name}</td><td>${a.teacher}</td>
                    <td><button onclick="viewReport('${a.id}')" style="color:blue; font-size:1.2em;">ğŸ“„</button><button onclick="delItem('${a.id}')" style="color:red; margin-right:15px; font-size:1.2em;">ğŸ—‘ï¸</button></td>
                </tr>
            `).join('');
            document.getElementById('adminTeachersGrid').innerHTML=teachers.map(t=>`
                <div class="teacher-item" style="cursor:default;">
                    <img src="${getTeacherImg(t)}" class="avatar-lg">
                    <div style="font-weight:bold;">${t.name}</div>
                    <div style="margin-top:15px; display:flex; justify-content:center; gap:15px;">
                        <button onclick="openEditTeacher('${t.id}')" style="font-size:1.4em;">âœï¸</button>
                        <button onclick="delTProfile('${t.name}','${t.id}')" style="color:red; font-size:1.4em;">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        window.switchAdminTab=(t)=>{
            document.getElementById('adminActivitiesView').style.display=t==='activities'?'block':'none';
            document.getElementById('adminTeachersView').style.display=t==='teachers'?'block':'none';
            document.getElementById('tab-admin-acts').classList.toggle('active', t==='activities');
            document.getElementById('tab-admin-teach').classList.toggle('active', t==='teachers');
        }

        window.openAddTeacherModal = () => {
            document.getElementById('editTeacherId').value = ""; 
            document.getElementById('editTeacherName').value = "";
            document.getElementById('editTeacherGender').value = "male";
            document.getElementById('editTeacherPreview').style.display = 'none';
            tempTeacherFile = null; removePhotoFlag = false; 
            document.getElementById('teacherEditModal').classList.add('active');
        };
        
        window.openEditTeacher = (id) => {
            const prof = teachers.find(x => x.id === id); 
            if(!prof) return;
            document.getElementById('editTeacherId').value = id; 
            document.getElementById('editTeacherName').value = prof.name;
            document.getElementById('editTeacherGender').value = prof.gender || "male";
            const img = document.getElementById('editTeacherPreview');
            if(prof.photo && prof.photo.length > 5) { img.src = prof.photo; img.style.display = 'block'; } else { img.src = ''; img.style.display = 'none'; }
            tempTeacherFile = null; removePhotoFlag = false;
            document.getElementById('teacherEditModal').classList.add('active');
        };

        window.previewTeacherImage = (input) => {
            if(input.files && input.files[0]) {
                tempTeacherFile = input.files[0];
                removePhotoFlag = false;
                const img = document.getElementById('editTeacherPreview');
                img.src = URL.createObjectURL(tempTeacherFile);
                img.style.display = 'block';
            }
        };

        window.removeTeacherPhoto = () => {
            removePhotoFlag = true;
            tempTeacherFile = null;
            document.getElementById('editTeacherPreview').style.display = 'none';
        };

        async function upload(f){const d=new FormData();d.append("image",f); const r=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:"POST",body:d}); const j=await r.json(); return j.data.url;}

        window.saveTeacherChanges = async () => {
            const id = document.getElementById('editTeacherId').value;
            const name = document.getElementById('editTeacherName').value.trim();
            const gender = document.getElementById('editTeacherGender').value;
            if(!name) { showToast("ØªÚ©Ø§ÛŒÛ• Ù†Ø§Ùˆ Ø¨Ù†ÙˆÙˆØ³Û•"); return; }
            
            const btn = document.getElementById('btnSaveTeacher');
            const originalText = btn.innerText;
            btn.innerText = "... Ø¨Ø§Ø±Ú©Ø±Ø¯Ù†"; btn.disabled = true;

            try {
                let photoUrl = "";
                let oldName = "";
                if(id) {
                    const prof = teachers.find(x => x.id === id);
                    if(prof) { oldName = prof.name; photoUrl = prof.photo || ""; }
                }

                if(tempTeacherFile) photoUrl = await upload(tempTeacherFile);
                else if(removePhotoFlag) photoUrl = "";

                const data = { name, gender, photo: photoUrl };
                if(id) {
                    await updateDoc(doc(db, "teachers", id), data);
                    if(oldName && oldName !== name) {
                        const qMatches = acts.filter(a => a.teacher === oldName);
                        if(qMatches.length > 0) {
                            const batch = writeBatch(db);
                            qMatches.forEach(item => batch.update(doc(db, "activities", item.id), { teacher: name }));
                            await batch.commit();
                        }
                    }
                } else {
                    await addDoc(teachRef, data);
                }
                showToast("Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù† Ù¾Ø§Ø´Ú©Û•ÙˆØª Ú©Ø±Ø§Ù†");
                document.getElementById('teacherEditModal').classList.remove('active');
            } catch(e) {
                showToast("Ù‡Û•ÚµÛ• Ú•ÙˆÙˆÛŒØ¯Ø§");
            } finally {
                btn.innerText = originalText; btn.disabled = false;
            }
        }

        window.delTProfile=async(n, id)=>{
            customConfirm("Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§", `Ø¦Ø§ÛŒØ§ Ø¯ÚµÙ†ÛŒØ§ÛŒ Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ù¾Ø±Û†ÙØ§ÛŒÙ„ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§ (${n})ØŸ`, async () => {
                await deleteDoc(doc(db,"teachers",id));
                showToast("Ù…Ø§Ù…Û†Ø³ØªØ§ Ø³Ú•Ø§ÛŒÛ•ÙˆÛ•");
            });
        };

        window.openEditor=()=>{
            ['inpName','inpComm','inpTeacher','inpDate','inpNotes'].forEach(i=>document.getElementById(i).value='');
            document.getElementById('inpDate').value=new Date().toISOString().split('T')[0];
            window.localFiles=[null,null,null,null];
            for(let i=0;i<4;i++) {
                const el = document.getElementById('img'+i);
                el.src=''; el.style.transform = 'scale(1)';
                window.imgState[i] = {s:1, x:0, y:0};
            }
            enableEdit(true); document.getElementById('editorModal').classList.add('active');
        };
        window.closeEditor=()=>document.getElementById('editorModal').classList.remove('active');

        window.viewReport=(id)=>{
            const a=acts.find(x=>x.id===id); if(!a)return;
            document.getElementById('editorModal').classList.add('active'); document.getElementById('inpName').value=a.name; 
            document.getElementById('inpComm').value=a.committee||''; document.getElementById('inpTeacher').value=a.teacher; 
            document.getElementById('inpDate').value=a.date; document.getElementById('inpNotes').value=a.notes||'';
            for(let i=0;i<4;i++) {
                const el = document.getElementById('img'+i);
                el.src=a.images?.[i] || ''; el.style.transform = 'scale(1)';
                window.imgState[i] = {s:1, x:0, y:0};
            }
            enableEdit(!!user);
        }

        function enableEdit(ok){ ['inpName','inpComm','inpTeacher','inpDate','inpNotes'].forEach(i=>document.getElementById(i).disabled=!ok); document.getElementById('btnSaveArchive').style.display=ok?'inline-block':'none'; document.querySelectorAll('.controls').forEach(c=>c.style.display=ok?'flex':'none'); }

        window.saveToArchive=async()=>{
            const n=document.getElementById('inpName').value; const tName=document.getElementById('inpTeacher').value; if(!n||!tName) return;
            const btn = document.getElementById('btnSaveArchive');
            const originalText = btn.innerText;
            btn.innerText = "... Ø³Û•ÛŒÚ¤ Ø¯Û•Ú©Ø±ÛØª"; btn.disabled = true;

            try {
                const uploads = await Promise.all(window.localFiles.map(f => f ? upload(f) : null));
                const finalImages = uploads.filter(x => x);
                await addDoc(actRef,{ 
                    name:n, committee:document.getElementById('inpComm').value, 
                    teacher:tName, date:document.getElementById('inpDate').value, 
                    notes:document.getElementById('inpNotes').value, images:finalImages, createdAt:new Date() 
                }); 
                showToast("Ú†Ø§Ù„Ø§Ú©ÛŒ Ø²ÛŒØ§Ø¯Ú©Ø±Ø§!");
                closeEditor();
            } catch(e) {
                showToast("Ù‡Û•ÚµÛ• Ù„Û• Ø³Û•ÛŒÚ¤Ú©Ø±Ø¯Ù†");
            } finally {
                btn.innerText = originalText; btn.disabled = false;
            }
        }
        
        window.triggerFile=(i)=>{window.currentSlot=i; document.getElementById('hiddenFileInput').click();}
        document.getElementById('hiddenFileInput').addEventListener('change',e=>{
            const f=e.target.files[0]; if(f){ window.localFiles[window.currentSlot]=f; const r=new FileReader(); r.onload=ev=>document.getElementById('img'+window.currentSlot).src=ev.target.result; r.readAsDataURL(f); }
        });
        
        // DRAG & ZOOM
        let isD=false, aI=0, sX=0, sY=0, iX=0, iY=0;
        window.startDrag=(e,i)=>{if(document.getElementById('inpName').disabled)return; isD=true; aI=i; const c=e.touches?e.touches[0]:e; sX=c.clientX; sY=c.clientY; iX=imgState[i].x; iY=imgState[i].y;};
        window.addEventListener('mousemove',e=>{if(!isD)return; e.preventDefault(); upD(e.clientX-sX,e.clientY-sY)});
        window.addEventListener('touchmove',e=>{if(!isD)return; upD(e.touches[0].clientX-sX,e.touches[0].clientY-sY)},{passive:false});
        window.addEventListener('mouseup',()=>isD=false); window.addEventListener('touchend',()=>isD=false);
        function upD(dx,dy){const s=imgState[aI]; s.x=iX+dx; s.y=iY+dy; tr(aI);}
        window.adjustZoom=(i,v)=>{imgState[i].s=Math.max(0.1,imgState[i].s+v); tr(i);}
        function tr(i){const s=imgState[i]; document.getElementById('img'+i).style.transform=`translate(${s.x}px,${s.y}px) scale(${s.s})`;}

        window.setLayout=(t)=>document.getElementById('imgContainer').className=`p-images ${t}`;
        
        window.downloadJPEG = async () => {
            const paper = document.getElementById('reportPaper');
            const notes = document.getElementById('inpNotes');
            let notesDiv = null;

            // 1. Force fix dimensions for A4 capture (794px is approx 210mm at 96 DPI)
            const originalWidth = paper.style.width;
            const originalMinWidth = paper.style.minWidth;
            paper.style.width = '794px';
            paper.style.minWidth = '794px';

            if (notes && notes.value.trim() !== "") {
                notesDiv = document.createElement('div');
                notesDiv.innerText = notes.value;
                notesDiv.style.width = "100%";
                notesDiv.style.minHeight = notes.offsetHeight + "px";
                notesDiv.style.fontSize = "14px";
                notesDiv.style.whiteSpace = "pre-wrap";
                notesDiv.style.wordBreak = "break-word";
                notesDiv.style.fontFamily = "inherit";
                notesDiv.style.padding = "10px";
                notesDiv.style.color = "#333";
                notesDiv.style.border = "1px solid #ddd";
                notesDiv.style.marginBottom = "10px";
                notes.style.display = "none";
                notes.parentNode.insertBefore(notesDiv, notes);
            }

            window.scrollTo(0,0);

            // Use windowWidth in options to force desktop-like rendering of A4
            html2canvas(paper, { 
                scale: 2, 
                useCORS: true, 
                backgroundColor: "#ffffff",
                width: 794,
                windowWidth: 794
            }).then(canvas => {
                const imgDataURL = canvas.toDataURL('image/jpeg', 0.95); 
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

                if (isMobile) {
                    const previewDiv = document.createElement('div');
                    previewDiv.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:99999; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; padding:20px;";
                    previewDiv.innerHTML = `<div style="text-align:center;"><h3 style="margin-bottom:10px;">Ú•Ø§Ù¾Û†Ø±Øª Ø¦Ø§Ù…Ø§Ø¯Û•ÛŒÛ•</h3><p style="font-size:12px;color:#ccc;margin-bottom:15px;">Ø¨Û† Ø³Û•ÛŒÚ¤Ú©Ø±Ø¯Ù† Ø¯Û•Ø³Øª Ù„Û•Ø³Û•Ø± ÙˆÛÙ†Û•Ú©Û• Ø¯Ø§Ø¨Ú¯Ø±Û•</p></div><img src="${imgDataURL}" style="max-width:100%; max-height:70vh; border-radius:8px; box-shadow: 0 0 20px rgba(0,0,0,0.5);"><button onclick="this.parentElement.remove()" style="margin-top:20px; background:white; color:black; padding:10px 25px; border-radius:20px; font-weight:bold;">Ø¯Ø§Ø®Ø³ØªÙ†</button>`;
                    document.body.appendChild(previewDiv);
                } else {
                    const link = document.createElement('a');
                    link.download = (document.getElementById('inpName').value || 'Report') + '.jpg';
                    link.href = imgDataURL; link.click();
                }

                // Reset original styles
                paper.style.width = originalWidth;
                paper.style.minWidth = originalMinWidth;
                if (notes && notesDiv) { notes.style.display = ""; notesDiv.remove(); }
            });
        };
        
        window.delItem=async(id)=>{
            customConfirm("Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ", "Ø¦Ø§ÛŒØ§ Ø¯ÚµÙ†ÛŒØ§ÛŒ Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø¦Û•Ù… Ú†Ø§Ù„Ø§Ú©ÛŒÛŒÛ•ØŸ", async () => {
                await deleteDoc(doc(db,"activities",id));
                showToast("Ú†Ø§Ù„Ø§Ú©ÛŒ Ø³Ú•Ø§ÛŒÛ•ÙˆÛ•");
            });
        };
    </script>
</body>
</html>
